<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walmart AI Chat Simulation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right, #007bff, #1a237e);
        }
        .chat-container {
            height: calc(100vh - 4rem);
            max-width: 800px;
            margin: 2rem auto;
            display: flex;
            flex-direction: column;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            background-color: white;
        }
        .message-bubble {
            max-width: 80%;
        }
        .user-message {
            background-color: #e2f0ff;
            color: #004d99;
        }
        .ai-message {
            background-color: #f3f4f6;
            color: #333;
        }
        .loading-animation {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4a90e2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">
    <div class="chat-container">
        <header class="p-4 bg-gray-800 text-white text-center text-2xl font-bold">
            Walmart GenAI Chat v2
</header>
        <div id="status-message" class="p-2 text-center text-sm font-semibold text-green-600">
            Chat simulation running.
        </div>
        <div id="chat-window" class="flex-1 p-6 overflow-y-auto space-y-4">
            <!-- Chat messages will be appended here -->
        </div>
        <form id="chat-form" class="p-4 border-t border-gray-200 bg-white flex items-center">
            <input type="text" id="prompt-input" placeholder="Ask about Walmart policies..."
                   class="flex-1 p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button type="submit" id="send-btn"
                    class="ml-4 p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition duration-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                </svg>
            </button>
        </form>
    </div>
    <script>
        // Use the correct IDs from the HTML
        const chatWindow = document.getElementById('chat-window');
        const promptInput = document.getElementById('prompt-input');
        const chatForm = document.getElementById('chat-form');

        // URL del servicio de la API dentro del clúster de Kubernetes
        const API_URL = "http://localhost:8000/ask"; 

        function addMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message-bubble', 'rounded-lg', 'p-3', 'shadow-md');
            if (sender === 'user') {
                messageElement.classList.add('bg-blue-100', 'text-blue-800', 'self-end');
                messageElement.style.marginLeft = 'auto'; // Align to the right
            } else {
                messageElement.classList.add('bg-gray-100', 'text-gray-800', 'self-start');
                messageElement.style.marginRight = 'auto'; // Align to the left
            }
            messageElement.innerHTML = `<p class="font-semibold">${sender === 'user' ? 'Tú' : 'Asistente'}:</p><p>${message}</p>`;
            chatWindow.appendChild(messageElement);
            chatWindow.scrollTop = chatWindow.scrollHeight; // Auto-scroll
        }

        async function sendMessage() {
            const userMessage = promptInput.value.trim();
            if (userMessage === '') return;

            addMessage('user', userMessage);
            promptInput.value = '';

            const loadingIndicator = document.createElement('div');
            loadingIndicator.id = 'loading-indicator';
            loadingIndicator.classList.add('flex', 'items-center', 'space-x-2', 'p-3');
            loadingIndicator.innerHTML = `<div class="loading-animation"></div><p>El asistente está escribiendo...</p>`;
            chatWindow.appendChild(loadingIndicator);
            chatWindow.scrollTop = chatWindow.scrollHeight;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ prompt: userMessage })
                });

                if (!response.ok) {
                    throw new Error(`Error de red: ${response.status}`);
                }

                const data = await response.json();
                
                chatWindow.removeChild(loadingIndicator);
                addMessage('ai', data.response);

            } catch (error) {
                console.error('Error sending request:', error);
                
                const currentLoadingIndicator = document.getElementById('loading-indicator');
                if (currentLoadingIndicator) {
                    chatWindow.removeChild(currentLoadingIndicator);
                }
                
                addMessage('ai', 'I am sorry the AI asistand is not working, please check the backend.');
            }
        }

        chatForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage();
        });
    </script>
</body>
</html>